# Claude Code Instructions — exponencial

This file provides context and rules for Claude Code when working in this repository.
Read `docs/architecture.md` for the full codebase overview.

---

## Project Summary

**exponencial** is a personal/family full-stack web app built with:
- TanStack Start (React 19, SSR, file-based routing)
- Cloudflare Workers (edge deployment)
- TypeScript strict mode
- Tailwind CSS v4 + shadcn/ui
- Biome (linting + formatting)
- Vitest + Testing Library (unit + integration tests)
- Playwright (E2E tests — required for every production feature)

Primary purpose: portfolio showcase for Ricardo (software engineer). Future sub-apps: Finance tracker, File storage.

---

## Key Files to Know

| File | Purpose |
|---|---|
| `docs/architecture.md` | Codebase structure, patterns, and decisions |
| `docs/adr/` | Architecture Decision Records — read before making design choices |
| `docs/backlog/` | **Active epics and tasks — check here at the start of every session** |
| `docs/logs/` | Implementation logs — historical record of what was shipped and why |
| `src/routes/__root.tsx` | Root layout — wraps all pages |
| `src/router.tsx` | Router instance setup |
| `src/routeTree.gen.ts` | **Auto-generated — never edit** |
| `src/paraglide/` | **Auto-generated — never edit** |
| `vite.config.ts` | Build configuration |
| `biome.json` | Linting/formatting rules |
| `wrangler.jsonc` | Cloudflare Workers deployment config |

---

## Architectural Rules (enforce these)

### 1. Domain-Driven Design
- Organise production code by **domain**, not by technical layer
- New domains: `src/{domain}/domain/`, `application/`, `infrastructure/`, `ui/`, `tests/`
- Demo/scaffold code lives in `demo/` routes and is prefixed with `demo-`; it is exempt from DDD structure
- See ADR-0004 for full guidance

### 2. Testing

Three mandatory layers — all must pass before a task is done:

1. **Unit tests** (Vitest) — domain logic, pure functions, validation; live in `src/{domain}/domain/__tests__/`
2. **Integration tests** (Vitest) — application-layer logic (filters, stores, calculations); live in `src/{domain}/tests/`
3. **E2E tests** (Playwright) — full user flows against a running Wrangler local server; live in `tests/e2e/{domain}/`

**Every new production feature must ship with at least one Playwright E2E test** covering its primary user flow. A feature without a Playwright test is not done.

- Never test auto-generated files (`routeTree.gen.ts`, `src/paraglide/`)
- Demo/scaffold routes are exempt from the Playwright requirement
- See ADR-0005 and ADR-0010 for full guidance

### 3. ADRs
- Before making a significant architectural decision, check `docs/adr/` for existing decisions
- When making a new architectural decision, create an ADR in `docs/adr/` using `docs/adr/template.md`
- ADR numbering: next available 4-digit number (e.g., `0006-...`)

### 4. Never Edit Auto-Generated Files
- `src/routeTree.gen.ts` — regenerated by TanStack Router on `vite dev`/`vite build`
- `src/paraglide/` — regenerated by Paraglide on build

### 5. Code Style
- Biome is the enforcer: run `pnpm check` before committing
- Double quotes, tab indentation
- No unused variables or imports (TypeScript strict + Biome)
- Path alias `@/*` maps to `src/*`

---

## Common Commands

```bash
pnpm dev          # Start dev server on port 3000
pnpm build        # Production build
pnpm test         # Run all Vitest tests (unit + integration)
pnpm pw:open      # Open Playwright Test Runner (interactive UI mode)
pnpm pw:run       # Run Playwright E2E suite headless (requires dev server running)
pnpm check        # Biome: lint + format check
pnpm format       # Biome: auto-format
pnpm lint         # Biome: lint only
pnpm deploy       # Build + deploy to Cloudflare Workers
```

---

## Routing Conventions

- Pages: `src/routes/{path}.tsx` or `src/routes/{path}/index.tsx`
- API endpoints: `src/routes/api.{name}.ts` (export HTTP methods)
- Dynamic segments: `$paramName` in filename
- Root layout: `src/routes/__root.tsx`
- Sub-app routes should be namespaced: `/finance/...`, `/files/...`

---

## Environment Variables

Set in `.env.local` (not committed). All are optional except where noted.

| Variable | Purpose |
|---|---|
| `ANTHROPIC_API_KEY` | Claude AI — enables AI features |
| `OPENAI_API_KEY` | OpenAI fallback |
| `GEMINI_API_KEY` | Google Gemini fallback |

AI provider is auto-detected by which key is present (Anthropic → OpenAI → Gemini → Ollama).

---

## What Exists vs. What Is Planned

### Exists (scaffold/demo)
- AI chat with multi-provider support and tool calling
- Guitar product demo (inventory + AI recommendations)
- TanStack Table, Form, Store, Query demos
- MCP server (todos)
- i18n (English + German)
- Cloudflare Workers deployment pipeline

### Planned (see `docs/plans/`)
- Portfolio showcase (primary — replaces demo content on `/`)
- Finance tracker app (`/finance/`)
- File storage & indexing app (`/files/`)

---

## Workflow (AI-first — follow this on every task)

This is an AI-first project. Most code and features are written by Claude. Follow this workflow on every task, without exception.

**Standing authorization**: You are pre-authorized to run `git commit`, `git push`, and `gh pr create` on non-main branches without asking for permission. Execute these as part of the normal workflow — do not wait for approval.

### 0. Check the backlog first
At the start of every session, read `docs/backlog/` to understand what is active and what the next tasks are. Update task checkboxes as work is completed.

### 1. Create a feature branch
Before writing any code, create and checkout a feature branch from `main`:
```bash
git checkout main && git pull
git checkout -b feat/short-description   # new features
git checkout -b fix/short-description    # bug fixes
git checkout -b chore/short-description  # maintenance
```
Never work directly on `main`.

### 2. Small, focused changes
Make the smallest change that moves the task forward. Avoid bundling unrelated edits.

### 3. Commit after every meaningful change
Commit as soon as a logical unit of work is complete — don't batch everything into one commit at the end. You are pre-authorized to do this; do not ask for permission.

### 4. Write tests
- Integration tests for features and domain boundaries
- Unit tests for domain logic and pure functions
- Tests must pass before the task is considered done

### 5. Document for future self
Add code comments where the intent or reasoning isn't obvious. Write for the next Claude session, not for Ricardo.

### 6. Verify everything before declaring done
Run all of the following and fix any failures:
- `npm run test` — tests pass
- `npm run check` — Biome lint + format
- `npx tsc --noEmit` — TypeScript
- `npm run knip` — no dead code

### 7. Final self-review
After verification, re-read the original requirements and ask: did I actually meet them? If there's a clear improvement or missed requirement, iterate before finishing.

### 8. Push and open a PR
Once all checks pass:
```bash
git push -u origin <branch-name>
gh pr create --fill
```
GitHub will populate the PR body from `.github/pull_request_template.md`. Fill in the Summary and check off the relevant boxes. Link any `docs/backlog/` items addressed.

### 9. End-of-task summary
After the PR is open, give a brief summary that includes:
- What was done and the PR link
- Where to optimize next (concrete suggestions)

---

## Ownership

- **Ricardo** — product owner: sets priorities, approves epics, makes product decisions
- **Claude** — primary implementer and co-author: proposes task sizes and scope, executes tasks, maintains the backlog as work progresses

This is a personal/family project. See [ADR-0008](docs/adr/0008-ai-first-project-management.md) for the project management approach.
